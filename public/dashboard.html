<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        background-color: #e3f2fd;
      }
      .card {
        padding: 10px;
        border: 1px solid black;
        margin-bottom: 10px;
      }
      .card-title {
        font-weight: 600;
        font-size: 3em;
        padding: 0 0 10px 0;
      }
      .card-description {
        font-weight: 400;
        font-size: 2em;
      }
    </style>
  </head>
  <body>
    <template id="card-template">
      <div class="card">
        <div class="card-body">
          <div class="card-id"></div>
          <div class="card-title"></div>
          <div class="card-text"></div>
        </div>
        <button
          class="card-button edit-button"
          cardId="none"
          onclick="handleShowEditForm()"
        >
          Edit
        </button>
        <div class="edit-form" cardId="none" style="display: none">
          <label for="title"><b>Title:</b></label>
          <input
            id="title"
            type="text"
            placeholder="Enter title"
            name="title"
            required
          />

          <label for="text"><b>Text:</b></label>
          <input
            id="text"
            type="text"
            placeholder="Enter text"
            name="text"
            required
          />

          <button class="card-button" cardId="none" onclick="handleEditCard()">
            Post
          </button>
        </div>
      </div>
    </template>
    <h1>Dashboard</h1>
    <div class="container">
      <label for="title"><b>Title:</b></label>
      <input
        id="title"
        type="text"
        placeholder="Enter title"
        name="title"
        required
      />

      <label for="text"><b>Text:</b></label>
      <input
        id="text"
        type="text"
        placeholder="Enter text"
        name="text"
        required
      />

      <button onclick="handlePost()">Post</button>
    </div>

    <div id="card-list"></div>

    <script>
      function handleShowEditForm() {
        const cardId = event.target.getAttribute("cardId");
        console.log("dashboard.html - handleShowEditForm:", cardId);

        // find the edit form using class and attribute
        const editForm = document.querySelector(
          `.edit-form[cardId="${cardId}"]`
        );

        // find the edit button using class and attribute
        const editFormButton = document.querySelector(
          `.edit-button[cardId="${cardId}"]`
        );

        // toggle showing the form
        if (editFormButton.innerText === "Edit") {
          // update the edit form style to show
          editForm.style.display = "inline";

          //change the button to say cancel
          editFormButton.innerText = "Cancel";
        } else if (editFormButton.innerText === "Cancel") {
          // hide the form with display: none;
          editForm.style.display = "none";

          //change the button to say edit
          editFormButton.innerText = "Edit";
        }
      }

      function handleEditCard() {
        const cardId = event.target.getAttribute("cardId");
        console.log("dashboard.html - handleEditCard:", cardId);

        // get the data from the inputs using the id+cardId
        const title = document.querySelector(`#title-${cardId}`).value;
        const text = document.querySelector(`#text-${cardId}`).value;

        fetch(`http://localhost:3000/api/cards/${cardId}`, {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            title: title,
            text: text,
          }),
        })
          .then((response) => response.json())
          .then((json) => {
            const data = json.result;

            // clear cards from page
            document.querySelector("#card-list").innerHTML = "";

            data.forEach((element) => {
              addCard(element.title, element.text, element.id);
            });
          });
      }

      function handlePost() {
        // extract data from form
        const title = document.getElementById("title").value;
        const text = document.getElementById("text").value;

        console.log("dashboard.html - handlePost:", title, text);

        fetch("http://localhost:3000/api/cards/post", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            title: title,
            text: text,
          }),
        })
          .then((response) => response.json())
          .then((json) => {
            console.log("dashboard.html - handlePost response:", json);

            const data = json.result;

            // clear cards from page
            document.querySelector("#card-list").innerHTML = "";

            // add cards to page
            data.forEach((element) => {
              addCard(element.title, element.text, element.id);
            });
          });
      }

      function addCard(title, text, id) {
        //clone the template
        const template = document
          .getElementById("card-template")
          .content.cloneNode(true);

        // populate template
        template.querySelector(".card-title").innerText = title;
        template.querySelector(".card-text").innerText = text;
        template.querySelector(".card-id").innerText = id;

        // get all buttons for the card, to add id
        const cardButtons = template.querySelectorAll(".card-button");

        // loop over cardButtons, add the id
        cardButtons.forEach((element) => element.setAttribute("cardId", id));

        // add id to edit form container, so we can select which to show
        template.querySelector(".edit-form").setAttribute("cardId", id);

        // add id to the edit input fields
        template.querySelector("#title").id = `title-${id}`;
        template.querySelector("#text").id = `text-${id}`;

        // add the populated template to page
        document.querySelector("#card-list").appendChild(template);
      }

      //data.forEach((element) => {
      //addCard(element.title, element.text)
      //})

      fetch("http://localhost:3000/api/cards")
        .then((response) => response.json())
        .then((json) => {
          console.log("Dashboard.html - fetch: ", json.result);
          //get the data from the result object
          const data = json.result;

          // loop over the data array, and populate template
          data.forEach((element) => {
            addCard(element.title, element.text, element.id);
          });
        });
    </script>
  </body>
</html>
